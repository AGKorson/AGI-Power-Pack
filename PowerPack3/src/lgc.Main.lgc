[ ********************************************************************[[ lgc.Main: Main logic[[ This logic runs in every interpreter cycle and calls[ other logics as needed.[[[ To better manage variables and flags, they are [ grouped into reserved, global, local, and dynamic:[[ reserved = reserved by the interpreter [ (  v0 - v26;     f0 - f16, f20)[[ global = usable and accessible by all logics[ ( v30 - v219;   text80 - menuInput, f21 - f219)[[ local = usable and accessible by single room[ (v220 - v239;  f220 - f239)[[ dynamic = usable and accesible by a non-room logic[ (v240 - v255;  f240 - f255)[[ Local and dynamic variables/flags are reset whenever a new room is[ loaded.[[ ********************************************************************[set(f10);[trace.on();call(255);[ ideally, these should be defined in the global list (or a [ defines.txt file, if you are not using the global defines[ feature)#define IntVersion        v30#define VERSION_UNKNOWN     0#define VERSION_2089        1#define VERSION_2272        2#define VERSION_2411        3#define VERSION_2425        4#define VERSION_2426        5#define VERSION_2435        6#define VERSION_2439        7#define VERSION_2440        8#define VERSION_2903        9#define VERSION_2911       10#define VERSION_2912       11#define VERSION_2915       12#define VERSION_2917       13#define VERSION_2936       14#define VERSION_3002086    15#define VERSION_3002098    16#define VERSION_3002102    17#define VERSION_3002107    18#define VERSION_3002149    19[ **************************************[ LOCAL DEFINES[ **************************************#define rndNum                     v255[ **************************************[ ERROR CHECK[ **************************************[ if one of the few trappable errors in AGI is encountered, the game[ is probably not able to continue; make an announcement to the player[ and quitif (errorNumber > 0)   {  call(lgc.Error);   }[ **************************************[ GAME START[ **************************************[ when game begins, or restarts, there are a number of setup [ activities to take care ofif (currentRoom == 0) {  [ when the game starts or restarts, the current room is zero, so all the  [ setup/initialization code goes here  [ restarting a game sets currentRoom to zero, and also requires some  [ setup/initialization steps  if (gameRestarted) {    [ retrieve interpreter version from errorinfo (v18)    IntVersion = errorParameter;        print("Restarting - Version: %v30");    [ configure the screen, assign key controllers, and other startup    [ activities    call(lgc.Init);         [ menus are already set, but separators need to be 're-disabled'    disable.item(cDummy);    set(enableMenu);        [ go to first room on restart (skip Intro)    block(-20, 0, 0, 0); [ force-fade to black    new.room(rm.Entrance);  }  else {    [ when game starts for first time, additional setup steps are    [ needed        [ always get version as first thing when starting    call(lgc.versioncheck);        [ run powerpack modifications at very beginning, before any other    [ initializations -  unless specific version is already known, check    [ them all    call(lgc.mod3002086);    call(lgc.mod3002098);    call(lgc.mod3002102);    call(lgc.mod3002107);    call(lgc.mod3002149);        [ if desired, enable debugging when game starts    set.key(0, 32, cDebug);       set(debugging); [set script size BEFORE menuscript.size(60);      [ set up menu    set.menu("PwrPk");    set.menu.item("About      ", cAbout);    set.menu.item("Help   <F1>", cHelp);    set.menu("File");    set.menu.item("Save     <F5>", cSave);    set.menu.item("Restore  <F7>", cRestore);    [ extended characters make a better separator    set.menu.item("ÄÄÄÄÄÄÄÄÄÄÄÄÄ", cDummy);    set.menu.item("Restart  <F9>", cRestart);    set.menu.item("Quit  <Alt-Z>", cQuit);    set.menu("Action");    set.menu.item("See Object  <F4>", cShowObj);    set.menu.item("Inventory  <Tab>", cStatus);    set.menu("Special");    set.menu.item("Sound On/Off      <F2>", cToggleSound);    set.menu.item("Clock On/Off      <F6>", cClock);    set.menu.item("Pause            <Esc>", cPause);    set.menu("Speed");    set.menu.item("Normal ", cNormal);    set.menu.item("Slow   ", cSlow);    set.menu.item("Fast   ", cFast);    set.menu.item("Fastest", cFastest);    if (debugging) {      set.menu("Debug");      set.menu.item("Debug Help        ", cDebugHelp);      set.menu.item("Ego Info   <Alt-E>", cShowEgo);      set.menu.item("Pri Screen <Alt-P>", cShowPriority);      set.menu.item("Memory     <Alt-M>", cShowMem);      set.menu.item("Obj Info   <Alt-I>", cObjInfo);      set.menu.item("Coords     <Alt-X>", cXY);      set.menu.item("Get All           ", cGimme);    }    [ extra menus for 80 col mode    set.menu("Test Options");    set.menu.item("Toggle Autocycle", c44);    set.menu.item("Toggle Speed    ", c45);    set.menu.item("Custom Status   ", c46);        [ submit the menu (which makes it ready to use)    submit.menu();    [ disable the separator lines    disable.item(cDummy);    [ test string formats3 = "123456789 123456789 123456789 %s4";s4 = "123 456 789 123";s5 = "123456789 123456789 123456789 %s4";[print("before: %s3");if (compare.strings(s3, s5))  {[  print("s3==s5");  }else  {  print("error: s3 and s5 are different");  }block(-12, 3, 3, 0); [ strFormat[print("after: %s3");if (compare.strings(s3, s5))  {  print("error: s3==s5");  }else  {[  print("s3 and s5 are different");  }  [ check for mouseif (isset(enableDblClick))  {[  print("mouse found");  }else  {  print("no mouse");  } [ test setmessages4 = "new message";print("before: '%m40'");block(-21, 0, 40, 4);print("after:  '%m40'"); [ set flag to configure menuset(f40);set.text.attribute(BLUE, YELLOW);display(0, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}\n"              "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(2, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(3, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(4, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(5, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(6, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(7, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(8, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(9, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(10, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(11, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(12, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(13, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(14, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(15, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(16, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(17, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(18, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(19, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(20, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(21, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(22, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(23, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");display(24, 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890{}");print("sound channels: %v22");clear.lines(0, 24, GREEN);[ save colorsset.text.attribute(-1, 0);set.text.attribute(0, 0);display(0, 0, "áTEST°±²");set.text.attribute(1, 0);display(0, 10, "áTEST°±²");set.text.attribute(15, 0);display(0, 20, "áTEST°±²");set.text.attribute(0, 14);display(1, 0, "áTEST°±²");set.text.attribute(1, 14);display(1, 10, "áTEST°±²");set.text.attribute(15, 14);display(1, 20, "áTEST°±²");set.text.attribute(0, 15);[clear.lines(2, 2, 1);display(2, 0, "átest°±²");set.text.attribute(1, 15);display(2, 10, "áTEST°±²");set.text.attribute(15, 15);display(2, 20, "áTEST°±²");[ restore colorsset.text.attribute(0, -1);[v220 = GREEN;[v221 = YELLOW;[v222 = DK_GRAY;[init.disk();[configure.screen(220, 221, 222);set.string(s3, "a really really really really really long string.");print("%s3");print("€‚ƒ„…†‡ˆ‰Š‹ŒŽ\n"      "‘’“”•–—˜™š›œžŸ\n"      " ¡¢£¤¥¦§¨©ª«¬­®¯\n"      "°±²³´µ¶·¸¹º»¼½¾¿\n"      "ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏ\n"      "ÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞß\n"      "àáâãäåæçèéêëìíîï\n"      "ðñòóôõö÷øùúûüýþ");load.logics(lgc.TraceInfo);trace.info(lgc.TraceInfo, 3, 15);set(f10);[trace.on();        [ configure the screen, assign key controllers, and other startup    [ activities    call(lgc.Init);    [ disable game functions at start; they will be re-enabled after    [ title screen is done    set(disableGameFunctions);    [ start the game with the title screen    new.room(rm.Title);         [ intro/opening screen  }}[ **************************************[ EVERY CYCLE[ **************************************[ if a new room has just been loadedif (newRoom) {  [ First interpreter cycle in a new room  [ Note: Everything other than logic 0 is discarded from memory when  [ new.room is executed  [ Load game specific functions logic into memory  load.logics(lgc.GameFunctions);   [ if debugging is active  if (debugging) {    [ load debug logic into memory    load.logics(lgc.Debug);  }  [ always animate ego object when starting a new room  animate.obj(ego);  [ load and set view (for more complex games, this will probably need   [ to be moved into each room's logic)  load.view.v(currentEgoView);  set.view.v(ego, currentEgoView);  observe.objs(ego);    [ clear bottom line of screen (remove ego's coords if shown)  clear.lines(24, 24, 0);      [ force clock value to update, if time is visible  clearStatusSeconds = 255; }[ check for ego death (usually happens a lot in AGI games...)if (deathType > 0) {  [ if this is first cycle since ego died  if (deathType != 255) {    [ disable most menu and keyboard shortcuts    disable.item(cDebugHelp);    disable.item(cSave);    disable.item(cPause);    disable.item(cShowObj);    disable.item(cClock);    disable.item(cNormal);    disable.item(cFastest);    disable.item(cFast);    disable.item(cSlow);    disable.item(cShowEgo);    disable.item(cShowPriority);    disable.item(cShowMem);    disable.item(cObjInfo);    disable.item(cXY);    disable.item(cGimme);    [ load the death handler logic    load.logics(lgc.Death);  }      [ call the death handler, which updates the screen and displays a   [ message to player about how ego died  call(lgc.Death);  [ don't process any other commands  return();}[ check for menu updateif (isset(f40))  {  reset(f40);  [ show/hide special, depending on col mode  if (isset(graphics80))    {    [ use longer main    s4 = m51;    block(-21, 0, 1, 4);        [ show the extras menu    s4 = m52;    block(-21, 0, 18, 4);    }  else    {    [ shorter main    s4 = m50;    block(-21, 0, 1, 4);    [ hide the extras menu    s4 = "";    block(-21, 0, 18, 4);    }  }#message 50 "PP"#message 51 "PwrPk"#message 52 "Test Options"[ ***********************[ CHECK CONTROLLER INPUT[ *********************** [ if normal game functions have not been disabledif (!disableGameFunctions) {  [ check for menu activation  if (controller(cMenu)) {    menu.input();  }  [ now check for any controllers that may have been activated  if (controller(cAbout)) {    print(gameAboutMsg);  }    if ((controller(cFastest) ||        said("fastest") ||        said("fastest", "speed"))) {    [ no delay between interpreter cycles    animationInterval = FASTEST_SPEED;  }    if ((controller(cFast) ||        said("fast") ||        said("fast", "speed"))) {    [ 1/20th of a second delay between interpreter cycles    animationInterval = FAST_SPEED;  }    if ((controller(cNormal) ||        said("normal") ||        said("normal", "speed"))) {    [ 2/20ths of a second delay between interpreter cycles    animationInterval = NORMAL_SPEED;  }  if ((controller(cSlow) ||        said("slow") ||        said("slow", "speed"))) {    [ 4/20ths of a second delay between interpreter cycles    animationInterval = SLOW_SPEED;  }    [ remember that sound controls only have an effect on non-PC systems  if (controller(cCrescendo) && attenuation > 0) {    [ to increase volume, lower sound attenuation variable    --attenuation;  }  if (controller(cDecrescendo) && attenuation < 15) {    [ to decrease volume, raise sound attenuation variable    ++attenuation;  }    [ toggle sound onn/off  if (controller(cToggleSound)) {    toggle(soundOn);  }      [ if debug mode is requested  if ((said("debug") || controller(cDebug))) {    [ if not in debug mode yet    if (!debugging) {      [ activate it      set(debugging);      [ display the game-about message      print(gameVersionMsg);      [ and interpreter version      version();      [ load debug logic into memory      load.logics(lgc.Debug);    }  }  [ save game  if ((controller(cSave) ||        said("save", "game") ||        said("save"))) {    save.game();  }  [ restore game  if ((controller(cRestore) ||        said("restore", "game") ||        said("restore"))) {    restore.game();  }  [ restart game  if ((controller(cRestart) ||        said("restart", "game") ||        said("restart"))) {    restart.game();  }  [ ask for help  if ((controller(cHelp) ||        said("help"))) {    call(lgc.GameHelp);  }  [ echo line draws previous input on input line  if (controller(cEchoLine)) {    s1 = "";    echo.line();  }  [ clear the input line  if (controller(cCancelLine)) {    cancel.line();  }  [ pause game (showing menu is another way to pause the game)  if ((controller(cPause) ||        said("pause", "game") ||        said("pause"))) {    pause();  }  [ check player's current inventory  if ((controller(cStatus) ||        said("inventory"))) {    status();  }  [ examine an object in player's inventory  if ((controller(cShowObj) ||        said("look", "inventory"))) {    [ enable section of inventory items    set(enableItemSelect);    [ show inventory screen    status();        [ selectedItem is set to 255 if ESC is pressed in the inventory    [ screen    if (selectedItem > 0 && selectedItem != 255) {      [ player has chosen an object (value of SelectedItem)      if (selectedItem == 1) {        s4 = "what is this thing?";        show.obj(vw.Inv.TestItem);      }      [ If you have several objects, it is easier to give them       [ consecutive view numbers. Then you can do the following (view      [ numbers start at 220 for this example):      [   v255 = selectedItem; v255 += 219;      [   show.obj.v(v255);      [ If you do this, you don't have to have separate statements for      [ each object.      }          [ disable selection of inventory items    reset(enableItemSelect); }  [ quit the game  if ((controller(cQuit) ||        said("quit", "game") ||        said("quit"))) {    stop.sound();    quit(0);  }  [ toggle clock feature  if ((said("clock") || controller(cClock))) {    toggle(clockOn);    [ if clock is now off    if (!clockOn)       {      [ force status line to redraw which removes clock text from      [ status line      status.line.on();     }    else  {      [ force clock to update this cycle      clearStatusSeconds = 255;     }  }}  [ ***********************[ NON-CONTROLLER CHECKS[ *********************** [ if clock display is neededif (clockOn && !disableGameFunctions) {  [ update the displayed clock whenever  [ the second value changes  if (clearStatusSeconds != elapsedSeconds) {    [ push current colors    set.text.attribute(-1, 0);    [    set.text.attribute(BLACK, WHITE);    [ update the clock    display(0, 18, " %v13:%v12|2:%v11|2 ");    [ pop colors    set.text.attribute(0, -1);    [ update the stored seconds value    clearStatusSeconds = elapsedSeconds;    [ adjust fps    fps = frames;    [reset frames    frames = 0;  }  [ display frame count and fps  display(0, 28, "(%v39/%v40)  ");  ++frames;}[ IMPORTANT: This calls the logic for the current room - this is not[ done automatically by the interpreter so it has to be called[ manually by logic 0.call.v(currentRoom);[ if debugging is active                if (debugging)   {  [ call the debugging logic  call(lgc.Debug);  }[ run game specific functions only if they are not disabledif (!disableGameFunctions)  {  call(lgc.GameFunctions);   }  [check player input for unknown wordsif (haveInput && !haveMatch && unknownWordNum > 0) {  reset(haveInput);  [copy word to a string  if (unknownWordNum == 1) {    word.to.string(unknownWord, w1);  }  if (unknownWordNum == 2) {    word.to.string(unknownWord, w2);  }  if (unknownWordNum == 3) {    word.to.string(unknownWord, w3);  }  if (unknownWordNum == 4) {    word.to.string(unknownWord, w4);  }  if (unknownWordNum == 5) {    word.to.string(unknownWord, w5);  }  if (unknownWordNum == 6) {    word.to.string(unknownWord, w6);  }  if (unknownWordNum == 7) {    word.to.string(unknownWord, w7);  }  if (unknownWordNum == 8) {    word.to.string(unknownWord, w8);  }  if (unknownWordNum == 9) {    word.to.string(unknownWord, w9);  }  if (unknownWordNum == 10) {    word.to.string(unknownWord, w10);  }  [choose a random unknown word response  random(33, 35, rndNum);  print.v(rndNum);}  [ finally, if there is input that hasn't been recognized yetif (haveInput && !haveMatch)    {  print("I don't understand your request.");  reset(haveInput);  }[ save clock values for comparison purposesoldSeconds = elapsedSeconds;oldMinutes = elapsedMinutes;oldHours = elapsedHours;oldDays = elapsedDays;return();[ **************************************[ DECLARED MESSAGES[ **************************************#message 1 "PwrPk"#message 2 "About      "#message 3 "Help   <F1>"#message 4 "ÄÄÄÄÄÄÄÄÄÄÄÄÄ"#message 5 "File"#message 6 "Save     <F5>"#message 7 "Restore  <F7>"#message 8 "menu is not available in this version"#message 9 "Restart  <F9>"#message 10 "Quit  <Alt-Z>"#message 11 "Action"#message 12 "See Object  <F4>"#message 13 "Inventory  <Tab>"#message 14 "Special"#message 15 "Sound On/Off      <F2>"#message 16 "Restarting - Version: %v30"#message 17 "Clock On/Off      <F6>"#message 18 "Test Options"#message 19 "Pause            <Esc>"#message 20 "Speed"#message 21 "Normal "#message 22 "Slow   "#message 23 "Fast   "#message 24 "Fastest"#message 25 "Debug"#message 26 "Ego Info   <Alt-E>"#message 27 "Pri Screen <Alt-P>"#message 28 "Memory     <Alt-M>"#message 29 "Obj Info   <Alt-I>"#message 30 "Coords     <Alt-X>"#message 31 "Get All           "#message 32 " %v13:%v12|2:%v11|2 "#message 33 "I don't understand \"%s2\""#message 34 "\"%s2\" is not in my vocabulary."#message 35 "What is \"%s2\""#message 36 "I don't understand your request."#message 37 "Debug Help        "#message 38 gameAboutMsg#message 39 gameVersionMsg#message 40 "test message"#message 41 "Toggle Autocycle"#message 42 "Toggle Speed    "#message 43 "Custom Status   "